<?php

include_once "sites/all/library/dbmng/dbmng.php";

//******************************************************************************
// Drupal Module 
// ====================
// Query
//******************************************************************************
function enpimodule_block_info() {
$blocks = array();
$blocks['last_item'] = array(
'info' => t('Last item'),
);

return $blocks;
}

function enpimodule_block_view($delta='') {
$block = array();

switch($delta) {
case 'last_item' :
$block['content'] = last_item_view();
break;
}

return $block;
}

function last_item_view() {
$html='';
$result = db_query('SELECT distinct id_test, nome FROM test order by nome desc ');
	$html.='<ul>';
		foreach ($result as $record) {
			$html.='<li><a href="?update_id_test=' . $record->id_test . '">' . $record->nome . '</li>';
		}
	$html.='</ul>';
return $html;
}

function enpimodule_menu() {
    $items = array();

    $items['enpimodule/hello'] = array(
        'title' => 'Hello World Test',
        'page callback' => 'say_hello_world',
        'access arguments' => array('access content'),
        'type' => MENU_CALLBACK,
     );

		 $items['enpimodule/hello/insert'] = array(
        'title' => 'Hello World Insert',
        'page callback' => 'say_hello_world_insert',
        'access arguments' => array('access content'),
        'type' => MENU_CALLBACK,
     );

    return $items;
}

function say_hello_world() {

		$table = 'test';
		
		$html  = t('Document page');

		//get the form!!!
		$id_table=1;
		$aForm = dbmng_get_form_array($id_table);



		if(isset($_POST['nome'])){
			// aggiornamento record esistente
			if(isset($_POST['update_record'])){
				$result = db_query('update ' . $table . ' set nome=:nome, eta=:eta WHERE id_test=:id_test', 
					array( 
						':nome' => $_POST['nome'] ,
						':eta' => intval($_POST['eta']), 
						':id_test' => intval($_POST['update_record'])
					)
				);
			}
			else{ //inserimento nuovo record
				$result = db_query('insert into ' . $table . ' (nome, eta) values (:nome, :eta)', 
					array( 
						':nome' => $_POST['nome'] ,
						':eta' => intval($_POST['eta']) 
					)
				);
			}
		}
		
		// delete record
		dbmng_create_form_delete($aForm);
		
		// duplicate record
		dbmng_create_form_duplicate($aForm);

		$html .= dbmng_create_table($aForm);

		$html .= dbmng_create_form($aForm);

    return ($html);

}


function say_hello_world_insert() {
		$html=t('This is a new page for insert');
    return ($html);
}
