<?php
include_once "sites/all/libraries/dbmng/dbmng.php";
include_once "sites/all/libraries/jpgraph/src/jpgraph.php";
include_once "sites/all/libraries/jpgraph/src/jpgraph_radar.php";
include_once "climasouth_assistance.php";
include_once "climasouth_resources.php";

//******************************************************************************
// Drupal Module 
// ====================
// Query
//******************************************************************************
function climasouth_block_info() 
{
	$blocks = array();
	$blocks['climasud_test'] = array(
		'info' => t('Climasouth test block'),
		);
	$blocks['climasouth_login'] = array(
		'info' => t('Climasouth Login block'),
		);
	$blocks['climasouth_map'] = array(
		'info' => t('Climasouth Map block'),
		);
	$blocks['climasouth_toolbar'] = array(
		'info' => t('Climasouth Toolbar'),
		);
	$blocks['climasouth_news'] = array(
		'info' => t('Climasouth news'),
		);
	$blocks['climasouth_menu_country'] = array(
		'info' => t('Climasouth menu country'),
		);
	$blocks['climasouth_menu_contacts'] = array(
		'info' => t('Climasouth menu contacts'),
		);
	$blocks['climasouth_knowledge_navigator'] = array(
		'info' => t('Climasouth Navigator'),
		);
	$blocks['climasouth_country_flag'] = array(
		'info' => t('Climasouth Country Flag'),
		);
	$blocks['climasouth_contribute_view'] = array(
		'info' => t('Climasouth contribute view'),
		);
	$blocks['climasouth_contribute_edit'] = array(
		'info' => t('Climasouth contribute edit'),
		);
	$blocks['climasouth_mng_req_ass'] = array(
		'info' => t('Climasouth manage request assistance'),
		);
	$blocks['climasouth_prj_workspace'] = array(
		'info' => t('Climasouth project workspace'),
		);
	
	return $blocks;
}

function climasouth_block_view($delta='') 
{
	$block = array();
	
	switch($delta) 
		{
			case 'climasud_test' :
				$block['content'] = _climasouth_block();
				break;
			case 'climasouth_map' :
				$block['content'] = _climasouth_map_block();
				break;
			case 'climasouth_login' :
				$block['content'] = _climasouth_login();
				break;
			case 'climasouth_toolbar' :
				$block['content'] = _climasouth_toolbar();
				break;			
			case 'climasouth_news' :
				$block['content'] = _climasouth_news(true);
				break;
			case 'climasouth_menu_country' :
				$block['content'] = _climasouth_menu_country();
				break;
			case 'climasouth_menu_contacts' :
				$block['content'] = _climasouth_menu_contacts();
				break;
			case 'climasouth_knowledge_navigator' :
				$block['content'] = _climasouth_knowledge_navigator();
				break;
			case 'climasouth_country_flag' :
				$block['content'] = _climasouth_country_flag();
				break;
			case 'climasouth_contribute_view' :
				$block['content'] = _climasouth_contribute_view();
				break;
			case 'climasouth_contribute_edit' :
				$block['content'] = _climasouth_contribute_edit();
				break;
			case 'climasouth_mng_req_ass' :
				$block['content'] = _climasouth_mng_request_assistance();
				break;
			case 'climasouth_prj_workspace' :
				$block['content'] = _climasouth_prj_workspace();
				break;
		}
	
	return $block;
}

function _climasouth_map_block() 
{
	dbmng_add_drupal_libraries();

	$html =  _climasouth_maps(true);

	return $html;
}


/* NOT Workig
function climasouth_init() 
{
	echo $_GET['q'];
	if(isset($_GET['q']) ) {
		if( $_GET['q'] == 'climasouth/workspace/resource/view') {
		  drupal_goto('climasouth/workspace?act=ins&tbl=c_resource');
       
    }
	}
}
*/

function climasouth_url_inbound_alter(&$path, $original_path, $path_language) {
	
		if( $path == 'climasouth/resource/view') {
       $path = 'climasouth/workspace';
			 $_REQUEST['act'] = 'search';
			 $_REQUEST['tbl'] = 'c_resource';
    }  
		else if ( $path == 'climasouth/resource/edit') {
       $path = 'climasouth/workspace_edit';
			 $_REQUEST['act'] = 'ins';
			 $_REQUEST['tbl'] = 'c_resource';
    }  
}

function _climasouth_block() 
{
	$html = "";

	return $html;
}

function _climasouth_login() 
{
	$html = '<div id="climasouth_login">';	
	global $user;

	if ($user->uid) 
		{
		 $html .= '<span class="climasouth_username">'.l($user->name, 'user').'</span> - ';
		 $html .= l(t('Log out'), 'user/logout');
		}
	else
		{
			$html .=  l(t('Log in'), 'user');
		}

	$html.='</div>';
	return $html;
}


function _climasouth_toolbar() 
{
	dbmng_add_drupal_libraries();
	drupal_add_css( "sites/all/modules/climasouth/climasouth_module.css",array('cache' => false) );
    drupal_add_js("sites/all/modules/climasouth/climasouth_module.js",array('cache' => false));

	global $base_path;
	/*
	$reader   = $base_path."sites/default/social_icons/rss.png";
	$youtube  = $base_path."sites/default/social_icons/youtube.png";
	$twitter  = $base_path."sites/default/social_icons/twitter.png";
	$facebook = $base_path."sites/default/social_icons/facebook.png";
	$googlepl = $base_path."sites/default/social_icons/googleplus.png";
	
	$aClass = array('attributes' => array('class' => array('toolbar_link')));
	$html = '<div id="climasouth_toolbar">';	
	$html .= "<ul id='climasouth_toolbar_ul'>";
	$html .= "<li class='climasouth_toolbar'>".t('MULTIMEDIA')."</li>";
	$html .= "<li class='climasouth_toolbar'>".t('PRESS PACKS')."</li>";
	$html .= "<li class='climasouth_toolbar'>".l(t('CC KNOWLEDGE NAVIGATOR'),'navigator')."</li>";
	$html .= "<li class='climasouth_toolbar'>".l(t('CONTACTS'), 'contacts', $aClass)."</li>";
	$html .= "<li class='climasouth_toolbar'>".t('Official European Commission Website').": <a href='http://ec.europa.eu/europeaid/what/development-policies/intervention-areas/environment/climate_en.htm'>EuropeAid's page on climate change</a><br/>".t('This programme is founded by the European Union')."</li>";
	$html .= "<li class='climasouth_toolbar'><img src='".$reader."'></li>";
	$html .= "<li class='climasouth_toolbar'><img src='".$youtube."'></li>";
	$html .= "<li class='climasouth_toolbar'><img src='".$twitter."'></li>";
	$html .= "<li class='climasouth_toolbar'><img src='".$facebook."'></li>";
	$html .= "<li class='climasouth_toolbar'><img src='".$googlepl."'></li>";
	$html .= "</ul>";

	$html.='</div>';
	*/
	
	$html = "";
	$html .= "<div id='climasouth_toolbar'>";	
	$html .= "<ul id='climasouth_toolbar_ul'>";
	$html .= "<li class='climasouth_toolbar'><a href='http://capacity4dev.ec.europa.eu/'>Capacity4dev.eu</a></li>";
	$html .= "<li class='climasouth_toolbar'>|</li>";
	$html .= "<li class='climasouth_toolbar'><a href='http://www.enpi-info.eu/'>".t('EU Neighbourhood InfoCenter')."</a></li>";
	$html .= "<li class='climasouth_toolbar'>|</li>";
	$html .= "<li class='climasouth_toolbar'>".l(t('CC Knowledge navigator'),'navigator')."</li>";
	$html .= "<li class='climasouth_toolbar'>|</li>";
	$html .= "<li class='climasouth_toolbar'>".l(t('Legal notice & disclaimer'),'legal_notice')."</li>";
	$html .= "<li class='climasouth_toolbar'>|</li>";
	$html .= "<li class='climasouth_toolbar'>".l(t('Contacts'),'node/130')."</li>";
	$html .= "<li class='climasouth_toolbar'>|</li>";
	$html .= "<li class='climasouth_toolbar'>".l(t('Credits'),'credit')."</li>";

	$html .= "</ul>";

	$html .= '<div class="agro_logo"><a href="http://www.agriconsulting.it/"><img src="'.$base_path.'/sites/all/modules/climasouth/resources/logo_agri260.png" /></a></div>';

	$html.='</div>';
	return $html;
}


function _climasouth_knowledge_navigator()
{
	drupal_add_js ( "http://kn.ids.ac.uk/widget/kn-widget.js" );
	$html = "";
	$html .= '<span id="kn-widget"></span>';
	
	return $html;
}

function _climasouth_country_flag()
{
	global $user;
	global $base_path;

	$uid =  l(t('Log in'), 'user');
	if ($user->uid) 
		{
			$opt = array('attributes' => array('class' => 'climasouth_link_blu'));
			$uid = l(t('Log out'), 'user/logout', $opt); //l($user->name, 'user', $opt) . " | " . 
		 //$html .= '<span class="climasouth_username">'.l($user->name, 'user').'</span> - ';
		 //$html .= l(t('log out'), 'user/logout');
		 
		}

	global $language ;
	$lang_name = $language->language ;
	
	//$rss = _climasouth_news_rss();

	$html = "<table id='flag_container'>";
	$html .= "<tr>";
	$html .= "<td><a href='".$base_path."node/136' class='country_link'>".t('Algeria')."</a></td>";
	$html .= "<td><a href='".$base_path."node/144' class='country_link'>".t('Jordan')."</a></td>";
	$html .= "<td><a href='".$base_path."node/142' class='country_link'>".t('Morocco')."</a></td>";
	//$html .= "<td><a href='".$base_path."node/141' class='country_link'>".t('Tunisia')."</a></td>";
	//$html .= "<td><a href='".$base_path."node/145' class='country_link'>".t('Syria')."</a></td>";
	$html .= "<td class='cs_last_col'><a class='climasouth_link_blu ".($lang_name=='ar'?'activel':'')."' href='".$base_path."ar' >".t('Arabic', array(), array('langcode'=>'ar'))."</a></td>";
	$html .= "</tr><tr>";
	$html .= "<td><a href='".$base_path."node/137' class='country_link'>".t('Egypt')."</a></td>";
	$html .= "<td><a href='".$base_path."node/139' class='country_link'>".t('Lebanon')."</a></td>";
	$html .= "<td><a href='".$base_path."node/143' class='country_link'>".t('Palestine')."</a></td>";
	$html .= "<td class='cs_last_col'><a class='climasouth_link_blu ".($lang_name=='en'?'activel':'')."' href='".$base_path."en' >".t('English', array(), array('langcode'=>'en'))."</a></td>";
	$html .= "</tr><tr>";
	$html .= "<td><a href='".$base_path."node/154' class='country_link'>".t('Israel')."</a></td>";
	$html .= "<td><a href='".$base_path."node/164' class='country_link'>".t('Libya')."</a></td>";
	$html .= "<td><a href='".$base_path."node/141' class='country_link'>".t('Tunisia')."</a></td>";
	$html .= "<td class='cs_last_col'><a class='climasouth_link_blu ".($lang_name=='fr'?'activel':'')."' href='".$base_path."fr' >".t('French', array(), array('langcode'=>'fr'))."</a></td>";
	$html .= "</tr><tr>";
	$html .= "<td>&nbsp;</td>";
	$html .= "<td>&nbsp;</td>";
	$html .= "<td>&nbsp;</td>";
	$html .= "<td class='cs_last_col loginlogout'><div id='cs_disconnecter'>".$uid."</div></td>";
	$html .= "</tr>";
	$html .= "</table>";

// 	$html = "<div id='flag_container'>";
// 	$html .= "<table id='flag_container'>";
// 	$html .= "<tr>";
// 	$html .= "<td><a href='".$base_path."node/136' class='country_link'>".t('Algeria')."</a></td>";
// 	$html .= "<td><a href='".$base_path."node/139' class='country_link'>".t('Lebanon')."</a></td>";
// 	$html .= "<td><a class='climasouth_link_blu ".($lang_name=='ar'?'activel':'')."' href='".$base_path."ar' >".t('Arabic', array(), array('langcode'=>'ar'))."</a></td>";
// 	$html .= "<td rowspan='5'><a href='http://www.enpi-info.eu/'><span><img id='cs_enpi' src='http://www.climasouth.eu/drupal/sites/all/modules/climasouth/resources/logo_enpi32.png' /></span></a></td>";
// 	$html .= "</tr><tr>";
// 	$html .= "<td><a href='".$base_path."node/137' class='country_link'>".t('Egypt')."</a></td>";
// 	$html .= "<td><a href='".$base_path."node/164' class='country_link'>".t('Libya')."</a></td>";
// 	$html .= "<td><a class='climasouth_link_blu ".($lang_name=='en'?'activel':'')."' href='".$base_path."' >".t('English', array(), array('langcode'=>'en'))."</a></td>";
// 	$html .= "</tr><tr>";
// 	$html .= "<td><a href='".$base_path."node/154' class='country_link'>".t('Israel')."</a></td>";
// 	$html .= "<td><a href='".$base_path."node/142' class='country_link'>".t('Morocco')."</a></td>";
// 	//$html .= "<td>&nbsp;</td>";
// 	$html .= "<td><a class='climasouth_link_blu ".($lang_name=='fr'?'activel':'')."' href='".$base_path."fr' >".t('French', array(), array('langcode'=>'fr'))."</a></td>";
// 	$html .= "</tr><tr>";
// 	$html .= "<td><a href='".$base_path."node/144' class='country_link'>".t('Jordan')."</a></td>";
// 	$html .= "<td><a href='".$base_path."node/143' class='country_link'>".t('Palestine')."</a></td>";
// 	//$html .= "<td>&nbsp;</td>";
// 	$html .= "<td class='loginlogout'>".$uid."</td>";
// 	$html .= "</tr><tr>";
// 	$html .= "<td><a href='".$base_path."node/145' class='country_link'>".t('Syria')."</a></td>";
// 	$html .= "<td><a href='".$base_path."node/141' class='country_link'>".t('Tunisia')."</a></td>";
// 	$html .= "</tr>";
// 	$html .= "</table>";
// 	$html .= "</div>";
	return $html;
}



function _climasouth_news_rss()
{

	if(isset($_REQUEST['ical'])){
		_climasouth_news_ical();
	}
	else 
		{

		$rss = '<?xml version="1.0" encoding="utf-8"?>';
		$rss .= '<rss version="2.0">';
		$rss .= '<channel>';
		$rss .= '<title>'.t('ClimaSouth feed').'</title>';
		$rss .= '<link>http://www.climasouth.eu/</link>';
		$rss .= '<description>'.t('News from the ClimaSouth News and Events web site').'.</description>';
	
		$res = dbmng_query("select * from c_news order by date_from desc ", array());

		foreach( $res as $rec )
			{
				$place = $rec->place;
				$title = cleanupXML($rec->title);
				$date_from = new DateTime($rec->date_from);
				$date_to = $rec->date_to;
				$node = $rec->linked_page;
				if(isset($date_to))
					$date_to = new DateTime($rec->date_to);

				$days = $date_from->format("d");
				$months = $date_from->format("F");
				$year = $date_from->format("Y");
			
				$timestamp = $rec->timestamp;
				$pubdate = date("D, d M Y H:i:s T", $timestamp);
		  
				if( isset($date_to) )
					{
						$date_to = new DateTime($rec->date_to);
						$days .= "-".$date_to->format("d");
					
						if( $months != $date_to->format("F") )
							$months .= " ".$date_to->format("F");

						if( $year != $date_to->format("Y") )
							$months .= " ".$date_to->format("Y");
					}
				$date = $days." ".$months." ".$year;
		
				$rss .= '<item>';
				$rss .= '<title>'.($title).'</title>';
				$rss .= '<link>'.url($node, array('absolute'=>TRUE)).'</link>';
				//$rss .= '<guid>'.l(($title),$node).'</guid>';
				$rss .= '<pubDate>'.$pubdate.'</pubDate>';
				$rss .= '<description>'.cleanupXML(strtoupper($place)) . " - " . $date. '</description>';
				$rss .= '</item>';
			}
		$rss .= '</channel>';
		$rss .= '</rss>';


		header("Content-Type: text/xml; charset=utf-8");
		echo $rss;
		module_invoke_all('exit');
		exit();
	}

	//return '';//$rss;
}




function _climasouth_news_ical()
{

?>
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//hacksw/handcal//NONSGML v1.0//EN
CALSCALE:GREGORIAN
<?php
		
	$res = dbmng_query("select * from c_news order by date_from desc ", array());

	foreach( $res as $rec )
		{
			$place = $rec->place;
			$title = ($rec->title);
			$date_from =  ($rec->date_from);
			$date_to =  ($rec->date_to);

			$node = $rec->linked_page;
			if(!isset($date_to))
				$date_to = $date_from;
	    

			?>
BEGIN:VEVENT
DTEND:<?= dateToCal(strtotime($date_to)) ?>

UID:<?= uniqid() ?>

DTSTAMP:<?= dateToCal(time()) ?>

LOCATION:<?= escapeString($place) ?>

DESCRIPTION:<?= escapeString($place) ?>

URL;VALUE=URI:<?= escapeString(url($node, array('absolute'=>TRUE))) ?>

SUMMARY:<?= escapeString($title) ?>

DTSTART:<?= dateToCal(strtotime($date_from)) ?>

END:VEVENT
<?php

			$iCal.='UID: '.uniqid();
			$iCal.='DTSTAMP: '.dateToCal(time());
			$iCal.='LOCATION: '.escapeString($place);
			$iCal.='DESCRIPTION: '.escapeString($place." ".$date);
			$iCal.='URL;VALUE=URI:'.escapeString(url($node, array('absolute'=>TRUE)));
			//SUMMARY:escapeString($summary) 
			$iCal.='DTEND: '.dateToCal($date_from);			




		}

	$ical .= 'END:VCALENDAR';

	header('Content-type: text/calendar; charset=utf-8');	
	echo $ical;
	module_invoke_all('exit');
	exit();

	//return '';//$rss;
}

function dateToCal($timestamp) {
  return date('Ymd\THis\Z', $timestamp);
}

// Escapes a string of characters
function escapeString($string) {
  return preg_replace('/([\,;])/','\\\$1', $string);
}

function cleanupXML($xml) {
    $xmlOut = '';
    $inTag = false;
    $xmlLen = strlen($xml);
    for($i=0; $i < $xmlLen; ++$i) {
        $char = $xml[$i];
        // $nextChar = $xml[$i+1];
        switch ($char) {
        case '<':
          if (!$inTag) {
              // Seek forward for the next tag boundry
              for($j = $i+1; $j < $xmlLen; ++$j) {
                 $nextChar = $xml[$j];
                 switch($nextChar) {
                 case '<':  // Means a < in text
                   $char = htmlentities($char);
                   break 2;
                 case '>':  // Means we are in a tag
                   $inTag = true;
                   break 2;
                 }
              }
          } else {
             $char = htmlentities($char);
          }
          break;
        case '>':
          if (!$inTag) {  // No need to seek ahead here
             $char = htmlentities($char);
          } else {
             $inTag = false;
          }
          break;
        default:
          if (!$inTag) {
             $char = htmlentities($char);
          }
          break;
        }
        $xmlOut .= $char;
    }
    return $xmlOut;
  }


function _climasouth_news($block, $type = null) 
{	
	global $base_path;
	$html ='';

	if(!$block)
		{
			$title=t('News & Events');
			if( isset($type) )
				if( $type == 'news' )
					$title = t("News");
				elseif( $type == 'events' )
					$title = t("Events");
			
			
			$html.="<script>jQuery(function(){jQuery('#page-title').html('".$title."'); jQuery(document).prop('title', '".$title."'); }); </script>";
		}

	$id="climasouth_news";
	if(!$block){
		$id.='_page';
	}
	$html .= '<div id="'.$id.'">';
	
	$sql_limit = "";
	if($block)
		{
			$html .= "<a href='".$base_path."/climasouth/news_events_rss'>";
			$html .= "<img class='rss_icon' src='".$base_path."/sites/all/modules/climasouth/resources/rss.png'>";
			$html .= "</a>";
			//$html .= '<h2 id="climasouth_news_h2">'.l(t('News & Events'),'climasouth/news_events').'</h2>';
			$html .= '<h2 id="climasouth_news_h2">'.l(t('News'),'climasouth/news').'</h2>';	//.' & '.l(t('Events'),'climasouth/events')

//		$html .= '<h2 id="climasouth_news_h2">'.l(t('News'),'climasouth/news_events',
//			array('attributes' => array('class' => array('btn btn-default')))).' - '.l(t('Events'),'climasouth/news_events',
//			array('attributes' => array('class' => array('btn btn-default')))).'</h2>';
			$sql_limit = " limit 3";
			$sql_where = "type = 1";
		}
	else
		{
	//		$html .='<div class="field field-name-field-image field-type-image field-label-above"><img typeof="foaf:Image" src="http://www.climasouth.eu/drupal/sites/all/modules/climasouth/resources/news.png" width="553" height="311" alt="" /></div>';

				$html .='<div class="field field-name-field-video field-type-text field-label-above"><div class="field-items"><div class="field-item even">player.vimeo.com/video/124107415</div></div></div>';	
		}
	
	/** load dinamically from database*/
	
	if( $block )
		{
			$where = $sql_where;
		}
	else
		{
			$where = "1";
			if( isset($type) )
				if( $type == 'news' )
					$where = "type = 1";
				elseif( $type == 'events' )
					$where = "type = 2";
		}
		
	$sql = "select * from c_news where $where order by date_from desc " . $sql_limit;
	$res = dbmng_query($sql, array());
	
	$html .= "<ul>"; 
	foreach ($res as $rec) {
		$place = $rec->place;
		$date_from = new DateTime($rec->date_from);
		$date_to = $rec->date_to;
		$node = $rec->linked_page;
		if(isset($date_to))
			$date_to = new DateTime($rec->date_to);
		
		global $language;
		$title = $rec->title;
		if( $language->language == 'ar' ){
			if($rec->title_ar!=null)
				$title = $rec->title_ar;
		}
		else if( $language->language == 'fr' ){
			if($rec->title_fr!=null)
				$title = $rec->title_fr;
		}
		
		$descr = $rec->description;
		if( $language->language == 'ar' ){
			if($rec->description_ar!=null)
				$descr = $rec->description_ar;
		}
		else if( $language->language == 'fr' ){
			if($rec->description_fr!=null)
				$descr = $rec->description_fr;
		}

		if( $language->language != 'ar' )
			{
				$days = $date_from->format("d");
				$months = $date_from->format("F");
				$year = $date_from->format("Y");
				
				if( isset($date_to) )
					{
						$date_to = new DateTime($rec->date_to);
						$days .= "-".$date_to->format("d");
						
						if( $months != $date_to->format("F") )
							$months .= " ".$date_to->format("F");

						if( $year != $date_to->format("Y") )
							$months .= " ".$date_to->format("Y");
					}
				$date = $days." ".$months." ".$year;
			}
		else
			{
				$days = $date_from->format("d");
				$months = $date_from->format("m");
				$year = $date_from->format("y");
				
				if( isset($date_to) )
					{
						$date_to_ar = new DateTime($rec->date_to);
						$days .= "-".$date_to_ar->format("d");
						
						if( $months != $date_to_ar->format("m") )
							$months .= " ".$date_to_ar->format("m");

						if( $year != $date_to_ar->format("y") )
							$months .= " ".$date_to_ar->format("y");
					}
					
				$your_date = $year."-".$months . "-" . $days; //date('y-m-d'); // The Current Date
				$date = date_convert2arabic($your_date);
			}
		
		if( $block )
			$descr = '';
		
		$html.="<li class='climasouth_news'><h3>".l(t($title),$node).'</h3>'.strtoupper(t($place)) . " - " . $date . "<br/>$descr</li>";
	}
	
	$html .= "</ul>";
	
	$html.='</div>';
	return $html;
}

function _climasouth_menu_country()
{
	$html = "";
	if( isset($_REQUEST['id_c_country']) )
		{
			$html = '<div id="climasouth_menu_country">';
			$html .= "<ul>";
			$html .= "<li class='climasouth_menu_country_li'>".t('Overview & key data')."</li>";
			$html .= "<li class='climasouth_menu_country_li'>".t('National climate policy')."</li>";
			$html .= "<li class='climasouth_menu_country_li'>".t('National reports')."</li>";
			$html .= "<li class='climasouth_menu_country_li'>".t('Climate Change projects')."</li>";
			$html .= "<li class='climasouth_menu_country_li'>".t('Focal Point')."</li>";
			$html .= "<li class='climasouth_menu_country_li'>".t('EU Delegation')."</li>";
			$html .= "</ul>";
		
			$html.='</div>';
		}
	return $html;
}

function _climasouth_menu_contacts()
{
	$html = "";
	$html = '<div id="climasouth_menu_contacts">';
	$html .= "<ul>";
	$html .= "<li class='climasouth_menu_contacts_li'>".t('EC/ DEVCO')."</li>";
	$html .= "<li class='climasouth_menu_contacts_li'>".t('EC/ DGCLIMA')."</li>";
	$html .= "<li class='climasouth_menu_contacts_li'>".t('National Focal Points')."</li>";
	$html .= "<li class='climasouth_menu_contacts_li'>".t('EU Delegations')."</li>";
	$html .= "<li class='climasouth_menu_contacts_li'>".t('Agriconsulting Consortium')."</li>";
	$html .= "</ul>";

	$html.='</div>';
	return $html;
}

function _climasouth_contribute_view()
{
	$html = "";

	$_REQUEST['tbl'] = 'c_resource';
	$html = _climasouth_workspace();

	return $html;
}

function _climasouth_contribute_edit()
{
	$html = "";

	$_REQUEST['tbl'] = 'c_resource';
	$_REQUEST['act'] = 'ins';
	$html = _climasouth_workspace();

	return $html;
}

function climasouth_menu() 
{
  $items = array();

  $items['climasouth/country'] = array(
      'title' => 'List of Countries',
      'page callback' => 'lst_country',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
   );

		$items['climasouth/news_events'] = array(
      'title' => 'News & Events',
      'page callback' => '_climasouth_news_events',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
   );

		$items['climasouth/news'] = array(
      'title' => 'News',
      'page callback' => '_clima_news',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
   );

		$items['climasouth/events'] = array(
      'title' => 'News',
      'page callback' => '_clima_events',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
   );

		$items['climasouth/news_events_rss'] = array(
      'title' => 'News & Events',
      'page callback' => '_climasouth_news_rss',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
   );


  $items['climasouth/workspace'] = array(
      'title' => 'Collaborative Workspaces',
      'page callback' => '_climasouth_workspace',
      'access arguments' => array('view workspace'),
      'type' => MENU_CALLBACK,
   );
	
	// this entry is similar to the previous one except the path
  $items['climasouth/resource_edit'] = array(
      'title' => 'Collaborative Workspaces resource edit mode',
      'page callback' => '_climasouth_workspace',
      'access arguments' => array('add_resource'),
      'type' => MENU_CALLBACK,
   );

   // this entry is similar to the previous one except the path
  $items['climasouth/resource_search'] = array(
      'title' => 'Collaborative Workspaces resource search mode',
      'page callback' => '_climasouth_resource_search',
      'access arguments' => array('view workspace'),
      'type' => MENU_CALLBACK,
   );

   $items['climasouth/assistance'] = array(
      'title' => 'Request Assistance',
      'page callback' => '_climasouth_assistance',
      'access arguments' => array('request assistance'),
      'type' => MENU_CALLBACK,
   );


   $items['climasouth/manage_assistance'] = array(
      'title' => 'Manage Assistance',
      'page callback' => '_climasouth_mng_request_assistance',
      'access arguments' => array('manage_assistance'),
      'type' => MENU_CALLBACK,
   );


	$items['climasouth/video_contest'] = array(
      'page callback' => '_climasouth_video_contest',
      'access arguments' => array('video contest')
   );

  return $items;
}

function lst_country() 
{
	//important add dbmng js & css
	dbmng_add_drupal_libraries();

	$html = "";

	if(isset($_REQUEST['id_c_country']))
		{
			$id_c_country=$_REQUEST['id_c_country'];
			
			$res = dbmng_query('select * from c_country WHERE id_c_country=:id_c_country', array('id_c_country' => intval($id_c_country) ));
			
			$cnt = dbmng_fetch_object($res);

			//$html.='<h3>'.$cnt->country_name.'</h3>';

			drupal_set_title(t($cnt->country_name));
			
						
			$html.= '<div id="climasouth_country">';

			if(	$cnt->flag !=null)
				{				
					$html.='<img id="climasouth_flag" src="'.base_path().$cnt->flag.'" />';
				}			 

			if(	$cnt->html_content !=null)
				{				
					$html.='<div id="climasouth_country_content">'.$cnt->html_content.'</div>';
				}			 
			
			$aCountry = array();
			$aCountry['id_c_country'] = $id_c_country;
			$aCountry['country_name'] = $cnt->country_name;

			//$file = _climasouth_graph( $aCountry );
			//if(strlen($file)>0)
			//	{
			//		$html .= '<img class="climasouth_radar_chart"  id="climasouth_graph" src="'.base_path().$file.'" />';
			//	}			
			$html.= '</div>';
		}
	else 
		{
			 $html.=  _climasouth_maps(false);
		}
	
	$html .= implode(' ', service_links_render(null, FALSE));  
return ($html);
}


function _climasouth_news_events() {
	$html="";
	$html=_climasouth_news(false);

	return $html;
}

function _clima_news() {
	$html="";
	$html=_climasouth_news(false, 'news');

	return $html;
}

function _clima_events() {
	$html="";
	$html=_climasouth_news(false, 'events');

	return $html;
}



function _climasouth_graph( $aCountry )
{
	$id_c_country = $aCountry['id_c_country'];
	$country_name = $aCountry['country_name'];
	
	$aPlot   = array();
	$aRadar0 = array();
	$aRadar1 = array();
	$aRadar2 = array();
	
	//Query to get the titles of the radar plot
	$sql = "select ass_type from c_assessment where id_c_voc_ass_group = 1 order by id_c_assessment";
	$res = dbmng_query( $sql, array() );
	$aTitles = array();
	foreach($res as $r)
		{
			$aTitles[] = $r->ass_type;
		}
	
	//Query to get the reference target value
	$sql = "select 5 as reference from c_ghg_assessment where id_c_country = :id_c_country order by id_c_assessment";
	$res = dbmng_query($sql, array('id_c_country' => intval($id_c_country) ));
	$aVal0 = array();
	foreach($res as $r)
		{
			$aVal0[] = $r->reference;
		}
	
	//Query to get the proposed target value
	$sql = "select proposed_target from c_ghg_assessment where id_c_country = :id_c_country order by id_c_assessment";
	$res = dbmng_query($sql, array('id_c_country' => intval($id_c_country) ));
	$aVal1 = array();
	foreach($res as $r)
		{
			$aVal1[] = $r->proposed_target;
		}
	
	//Query to get the current rating value
	$sql = "select current_rating from c_ghg_assessment where id_c_country = :id_c_country order by id_c_assessment";
	$res = dbmng_query($sql, array('id_c_country' => intval($id_c_country) ));
	
	$aVal2 = array();
	foreach($res as $r)
		{		$html .= $rec->req_name;

			$aVal2[] = $r->current_rating;
		}
	
	//reference
	$aRadar0['value']  = $aVal0;
	$aRadar0['legend'] = t("Reference"); 
	$aRadar0['color1'] = "black";
	$aRadar0['color2'] = "white";
	$aRadar0['mark']   = MARK_CROSS;
	
	//target
	$aRadar1['value'] = $aVal1;
	$aRadar1['legend']= t("Target");
	$aRadar1['color1'] = "blue";
	$aRadar1['color2'] = "white";
	$aRadar1['fill']   = "false";
	$aRadar1['line_weight'] = 2;
	$aRadar1['mark'] = MARK_IMG_STAR;
	
	//Current
	$aRadar2['value'] = $aVal2; 
	$aRadar2['legend']= t("Current rating");
	$aRadar2['color1'] = "red";
	$aRadar2['color2'] = "lightred";
	$aRadar2['line_weight'] = 10;
	$aRadar2['mark'] = MARK_IMG_SBALL;
			$html .= $rec->req_name;

	$aPlot['Title']      = t("Assessment of current GHG inventory preparation process versus needs in") . " " . $country_name;
	$aPlot['Titles']     = $aTitles;
	$aPlot['Filename']   = "GHG";
	$aPlot['width']      = 750;
	$aPlot['height']     = 400;
	$aPlot['background'] = "white";
	$aPlot['shadow']     = false;
	$aPlot['plot'][0]    = $aRadar0;
	$aPlot['plot'][1]    = $aRadar1;
	$aPlot['plot'][2]    = $aRadar2;
	
	if(count($aVal0)>0 && count($aVal1)>0 && count($aVal2)>0 )
		{
			$file = draw_radar_graph( $aPlot );
		}
	else
		{
			$file = '' ;
		}
	
	return $file;
}

function _climasouth_maps($block) 
{
	$html='';


	$show_map=0;

	$node = menu_get_object();
	if ($node && $node->nid) {
		// You have a valid node to work with.

		if($node->nid==1){
			$show_map=1;
		}
	}

	drupal_add_css( "sites/all/modules/climasouth/climasouth_module.css",array('cache' => false) );
	drupal_add_js("sites/all/modules/climasouth/climasouth_module.js",array('cache' => false));

	if($show_map==1){
		drupal_add_css('http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.ie.css', array('type' => 'external', 'weight' => CSS_THEME, 'browsers' => array('IE' => 'lt IE 8', '!IE' => FALSE), 'preprocess' => FALSE));
		drupal_add_css('http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css',array('type' => 'external'));
		drupal_add_js('http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js',array('type' => 'external'));

		$aForm    = dbmng_get_form_array("c_country"); 	
		/*
		//TODO: do not change title if called in a block
		$height="310";
		if(!$block)
			{
				drupal_set_title(t("Countries"));
				$height="400";
			}
		*/
	}


	$html .= '<div id="cs_top_banner">';

		$news_block='';

		if(request_path()=='' || request_path()=='en' || request_path()=='ar' || request_path()=='fr' ||request_path()=='climasouth/news_events')
			$news_block=_climasouth_news(true);
		else{
			$html.='<style>#map_new_container {background-image: none !important;}</style>';
		}

		$html .= '<div id="map_new_container">'.$news_block.'</div>';
		$html .= '<div id="label_container">&nbsp;</div>';
		//$html .= '<div id="map_info_container">&nbsp;</div>';
		$html .= '<div id="map_blue_left">&nbsp;</div>';

if($show_map==1){


		/*<ol class="carousel-indicators">
						<li data-target="#myCarousel" data-slide-to="0" class="active"></li>
						<li data-target="#myCarousel" data-slide-to="1"></li>
						<li data-target="#myCarousel" data-slide-to="2"></li>
					</ol>
		*/


				$html.='<div  style="width:1170px; height:311px;"  id="myCarousel" data-interval="3000" class="carousel slide">
			
					<!-- Carousel items -->
					<div class="carousel-inner">
						';
						$html .= '<div class="active item"><div id="map_container" style="width:1170px; height:311px;"  ><div id="map_info_container">&nbsp;</div></div></div>';
        $html.='<div class="item"><div id="label_container"><span style="vertical-align: middle;"><h5>Introduction to the ClimaSouth project<br/>Video – presentation</span></h5></div><div style="width:1170px; height:311px;"  ><iframe src="//player.vimeo.com/video/124107415?title=0&byline=0&portrait=0" width="553" height="311" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="" style="margin-left: 318px;"></iframe></div></div>';
        $html.='<div class="item"><div id="label_container"><span style="vertical-align: middle;"><h5>Climate Resilient Societies & <br/>Low Carbon Economies</span></h5></div><div style="width:1170px; height:311px;"  ><iframe src="//player.vimeo.com/video/148199077?title=0&byline=0&portrait=0" width="553" height="311" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="" style="margin-left: 318px;"></iframe></div></div>';

	$html.='<div class="item"><div id="label_container"><span style="vertical-align: middle;"><h5><a href="http://www.climasouth.eu/drupal/fr/node/242">French edition of Climasouth E-Handbook N.2 now available</a></h5>
</span></div><div class="cs_image_cropper"><img src="http://www.climasouth.eu/drupal/sites/default/files/handbook_fr2.png"></div></div>';

// to add a news item...
//	$html.='<div class="item"></div>'

$html.='
						
					</div>
					<!-- Carousel nav -->
					<a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
					<a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
				</div>';
		}
		else{
			$html .= '<div id="map_container" style="width:1170px; height:311px;"  >';
		//$html.='<div id="map_countries"><a href="http://www.climasouth.eu/drupal/node/177">PROJECT PARNTER COUNTRIES</a></div>';
		$html.=' </div>';
		}


		
	$html .= '</div>';

	$html .= "\n<script type='text/javascript'>jQuery( document ).ready(function() {\n";

	if($show_map==1){
		$html .= "var data=".dbmng_get_js_array($aForm, null).";\n";
		$html .= "var aForm=".json_encode($aForm).";\n";
		$html .= "var aParam={ 'div_element':'map_container', 'zoom': 4, 'base_path':'".base_path()."', 'coord': [30, 13] };\n";
		$html .= "climasouth_leaflet(data,aForm, aParam);\n";
	}
	else{
		$html .= "climasouth_no_map();\n";
	}

	$html .= "});</script>\n";

	return $html;
}



function climasouth_permission() {
	return array(
			  		'view workspace' => array('title'=>t('View the collaborative workspace') ),
  					 'add_resource' => array('title'=> t('Add resources to collaborative workspace') ),
	  				 'request assistance' => array('title'=> t('Request assistance') ),
		  			 'manage_assistance' => array('title'=> t('Manage Assistance') )
					);
}

// this function must be moved outside this module
// Reference:
// Manual: http://jpgraph.net/download/manuals/chunkhtml/index.html
// Radar: http://jpgraph.net/download/manuals/chunkhtml/ch16s02.html
function draw_radar_graph( $aPlot )
{
	// Create the basic rtadar graph
	$graph = new RadarGraph($aPlot['width'], $aPlot['height']);
	 
	// Set background color and shadow
	$graph->SetColor($aPlot['background']);
	if( isset($aPlot['shadow']) )
		if( $aPlot['shadow'] )
			$graph->SetShadow();
	 
	// Position the graph
	$graph->SetCenter(0.5,0.55);
	 
	// Setup the axis formatting     
	//$graph->axis->SetFont(FF_ARIAL,FS_BOLD);
	$graph->axis->SetWeight(2);
	 
	// Setup the grid lines
	$graph->grid->SetLineStyle("longdashed");
	$graph->grid->SetColor("navy");
	$graph->grid->Show();
	$graph->HideTickMarks();
	        
	// Setup graph titles
	$graph->title->Set($aPlot["Title"]);
	//$graph->title->SetFont(FF_VERDANA,FS_BOLD);
	$graph->SetTitles($aPlot["Titles"]);
	
	foreach ($aPlot['plot'] as $p) 
		{
			$plot = new RadarPlot($p['value']);
			$plot->SetLegend($p['legend']);
			$plot->SetColor($p['color1'],$p['color2']);
			if( isset( $p['fill'] ) )
				$plot->SetFill($p['fill']);
			
			if( isset($p['line_weight']) )
				$plot->SetLineWeight(2);
			
			if( isset($p['mark']) )
				$plot->mark->SetType($p['mark'],$p['color1']);
			
			$graph->Add($plot);
		} 

	// And output the graph
	$dir = "sites/all/tmp/";
	$sFile = $aPlot['Filename'] . "_" . time() . ".png";
	$graph->Stroke($dir.$sFile);
	
	return $dir.$sFile;
} 


function _climasouth_video_contest(){

  //drupal_add_http_header('Content-Type', 'application/json');

	$html='
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap 101 Template</title>

  </head>
 <body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand page-scroll" href="#page-top">Bookmark</a>
            </div>
				            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul class="nav navbar-nav">
						<li class="hidden"><a class="page-scroll" href="#page-top"></a></li><li><a class="page-scroll" href="#lavoro">Lavoro</a></li><li><a class="page-scroll" href="#cmsweb">CMS & Web</a></li><li><a class="page-scroll" href="#computer">Computer</a></li><li><a class="page-scroll" href="#banca">Banca</a></li><li><a class="page-scroll" href="#pisa">Pisa</a></li><li><a class="page-scroll" href="#multimedia">Multimedia</a></li><li><a class="page-scroll" href="#sport">Sport</a></li><li><a class="page-scroll" href="#varie">Varie</a></li>                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Intro Section -->
    <section id="intro" class="intro-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h1>Scrolling Nav</h1>
                    <p><strong>Usage Instructions:</strong> Make sure to include the <code>scrolling-nav.js</code>, <code>jquery.easing.min.js</code>, and <code>scrolling-nav.css</code> files. To make a link smooth scroll to another section on the page, give the link the <code>.page-scroll</code> class and set the link target to a corresponding ID on the page.</p>
                    <a class="btn btn-default page-scroll" href="#about">Click Me to Scroll Down!</a>
                </div>
            </div>
        </div>
    </section>


<section id="lavoro" class="lavoro-section"><div class="container"><div class="row"><div class="col-lg-12"><h1>Lavoro</h1><div class="lista_type"><h3>admin database</h3></div><div class="lista_div"><ul class="lista_ul"><li class="lista_li"><a class="btn btn-default page-scroll btn-width" href="http://localhost/phpmyadmin/" target="_blank">phpMyAdmin</a><span class="lista_note">[root | michele72]</span></li><li class="lista_li"><a class="btn btn-default page-scroll btn-width" href="http://localhost/phppgadmin/" target="_blank">phpPgAdmin</a></li></ul></div><div class="lista_type"><h3>CMS</h3></div><div class="lista_div"><ul class="lista_ul"><li class="lista_li"><a class="btn btn-default page-scroll btn-width" href="http://localhost/www.climasouth.eu/drupal/" target="_blank">ClimaSouth</a><span class="lista_note">[local installation]</span></li><li class="lista_li"><a class="btn btn-default page-scroll btn-width" href="http://www.climasouth.eu/drupal/" target="_blank">ClimaSouth</a><span class="lista_note">[remote installation]</span></li><li class="lista_li"><a class="btn btn-default page-scroll btn-width" href="http://localhost/ticket/" target="_blank">Ticket</a><span class="lista_note">[local installation]</span></li><li class="lista_li"><a class="btn btn-default page-scroll btn-width" href="http://www.tribuna.summer-festival.com/" target="_blank">Ticket</a><span class="lista_note">[remote installation]</span></li></ul></div></div></div></div></section><section id="cmsweb" class="cmsweb-section"><div class="container"><div class="row"><div class="col-lg-12"><h1>CMS & Web</h1></div></div></div></section>


<section id="computer" class="computer-section"><div class="container"><div class="row"><div class="col-lg-12"><h1>Computer</h1></div></div></div></section>


<section id="banca" class="banca-section"><div class="container"><div class="row"><div class="col-lg-12"><h1>Banca</h1></div></div></div></section>


<section id="pisa" class="pisa-section"><div class="container"><div class="row"><div class="col-lg-12"><h1>Pisa</h1></div></div></div></section>


<section id="multimedia" class="multimedia-section"><div class="container"><div class="row"><div class="col-lg-12"><h1>Multimedia</h1></div></div></div></section>


<section id="sport" class="sport-section"><div class="container"><div class="row"><div class="col-lg-12"><h1>Sport</h1></div></div></div></section>

<section id="varie" class="varie-section"><div class="container"><div class="row"><div class="col-lg-12"><h1>Varie</h1></div></div></div></section>

	
	
   		<!-- jQuery (necessary for Bootstrap JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Bootstrap -->
			<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

			<!-- Optional theme -->
			<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">

			<!-- Latest compiled and minified JavaScript -->
			<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->


 <!-- Scrolling Nav JavaScript -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script src="js/scrolling-nav.js"></script>




</body>
</html>
';


	echo $html;
}

function date_convert2arabic($your_date)
{
	$months = array(
		"Jan" => "يناير",
		"Feb" => "فبراير",
		"Mar" => "مارس",
		"Apr" => "أبريل",
		"May" => "مايو",
		"Jun" => "يونيو",
		"Jul" => "يوليو",
		"Aug" => "أغسطس",
		"Sep" => "سبتمبر",
		"Oct" => "أكتوبر",
		"Nov" => "نوفمبر",
		"Dec" => "ديسمبر"
	);

	$en_month = date("M", strtotime($your_date));

	foreach ($months as $en => $ar) {
		if ($en == $en_month) {
			$ar_month = $ar;
		}
	}

	$find = array (

		"Sat",
		"Sun",
		"Mon",
		"Tue",
		"Wed" ,
		"Thu",
		"Fri"

	);

	$replace = array (
		
		"السبت",
		"الأحد",
		"الإثنين",
		"الثلاثاء",
		"الأربعاء",
		"الخميس",
		"الجمعة"

	);

	$ar_day_format = date('D'); // The Current Day

	$ar_day = str_replace($find, $replace, $ar_day_format);


	header('Content-Type: text/html; charset=utf-8');
	$standard = array("0","1","2","3","4","5","6","7","8","9");
	$eastern_arabic_symbols = array("٠","١","٢","٣","٤","٥","٦","٧","٨","٩");
	$current_date = $ar_day.' '.date('d').' / '.$ar_month.' / '.date('Y');
	$arabic_date = str_replace($standard , $eastern_arabic_symbols , $current_date);

	// Echo Out the Date
	return $arabic_date;
}
